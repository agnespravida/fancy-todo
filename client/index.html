<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>

  <div id="login-page">
    <form id="submit-login-form">
      Email:<br>
      <input type="text" name="email" id="email-login"><br>
      Password:<br>
      <input type="password" name="password" id="password-login"><br>
      <button type="submit">Login</button>
    </form>
  </div>

  <form id="add-todo-form">
    <h1>Add Form</h1>
    Title:<br>
    <input type="text" id="title-add" name="title"><br>
    Description:<br>
    <input type="text" id="description-add" name="description"><br>
    Status:<br>
    <input type="text" id="status-add" name="status"><br>
    Due Date:<br>
    <input type="date" id="due_date-add" name="due_date"><br>
    <button type="submit">Submit</button>
  </form>

  <form id="edit-todo-form">
    <h1>Edit Form</h1>
    Title:<br>
    <input type="text" id="title-edit" name="title"><br>
    Description:<br>
    <input type="text" id="description-edit" name="description"><br>
    Status:<br>
    <input type="text" id="status-edit" name="status"><br>
    Due Date:<br>
    <input type="date" id="due_date-edit" name="due_date"><br>
    <button type="submit">Submit</button>
  </form>

  <div id ="main-page">
    <button id="btn-add-todo">Add Todo</button>
    <div id="todos-list">
      
    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script>
    function showLoginPage(){
      $("#login-page").show()
      $("#main-page").hide()
    }
    function showMainPage(){
      $("#login-page").hide()
      $("#main-page").show()
      $("#add-todo-form").hide()
      $("#edit-todo-form").hide()
      showTodos()
    }
    function login(email, password){
      $.ajax({
        method: "POST",
        url: "http://localhost:3000/login",
        data: {
          email,
          password
        }
      })
      .done(function( response ) {
        localStorage.setItem("access_token", response.access_token)
        console.log("Berhasil login")
        showMainPage()
      })
      .fail(xhr => {
        console.log(xhr)
      })
      .always(() => {
        $("#email-login").val("")
        $("#password-login").val("")
      });

    }
    function showTodos(){
      $.ajax({
        method: "GET",
        url: "http://localhost:3000/todos/",
        headers: {
          access_token: localStorage.getItem("access_token")
        }
        
      })
      .done(function( response ) {
        //console.log(response)
        $("#todos-list").empty()
        for (let i = 0; i < response.length; i++){
          $("#todos-list").prepend(`
          <div style="background-color: aqua;">
            <p><strong>${response[i].title}<strong></p>
            <p>${response[i].description}</p>
            <p>${response[i].due_date}</p><br>
            <button id="btn-delete-todo">Delete</button> <button id="btn-edit-todo" onclick="toggleEditForm(${response[i].id})">Edit</button>
          </div>
          `)
        }
      })
      .fail(xhr => {
        console.log(xhr)
      })

    }

    function addTodos(title, description, due_date, status){
      $.ajax({
        method: "POST",
        url: "http://localhost:3000/todos",
        headers: {
          access_token: localStorage.getItem("access_token")
        },
        data: {
          title,
          description,
          due_date,
          status
        }
      })
      .done(function( response ) {
        //localStorage.setItem("access_token", response.access_token)
        console.log("Berhasil menambah data")
        showMainPage()
      })
      .fail(xhr => {
        console.log(xhr)
      })
      .always(() => {
        $("#title-add").val("")
        $("#description-add").val("")
        $("due_date-add").val("")
        $("#status-add").val("")
      });
    }
    function toggleEditForm(id){
      $.ajax({
        method: "GET",
        url: "http://localhost:3000/todos/" + id,
        headers: {
          access_token: localStorage.getItem("access_token")
        }
        
      })
      .done(function(response) {
        $("#title-edit").val(response.title)
        $("#description-edit").val(response.description)
        $("#status-edit").val(response.status)
        $("#due_date-edit").val(response.due_date)

        $("#edit-todo-form").toggle()
        console.log(response)
      })
      .fail(function(xhr) {
        console.log(xhr)
      })
    }
    function editTodo(title, description, due_date, status, id){
      $.ajax({
        method: "PUT",
        url: "http://localhost:3000/todos/" + id,
        headers: {
          access_token: localStorage.getItem("access_token")
        },
        data: {
          title,
          description,
          due_date,
          status
        }
      })
      .done(function( response ) {
        //localStorage.setItem("access_token", response.access_token)
        console.log("Berhasil edit data")
        showMainPage()
      })
      .fail(xhr => {
        console.log(xhr)
      })
      .always(() => {
        $("#title-edit").val("")
        $("#description-edit").val("")
        $("due_date-edit").val("")
        $("#status-edit").val("")
      });
    }
    $(document).ready(function(){
      if(localStorage.getItem("access_token")){
        showMainPage()
      }
      else {
        showLoginPage()
      }

      $("#submit-login-form").on("submit", function(event){
        event.preventDefault()
        let email = $("#email-login").val()
        let password = $("#password-login").val()
        console.log({
          email,
          password
        })
        login(email, password)
      })
    })

      $("#btn-add-todo").on("click", function(){
        $("#add-todo-form").toggle()
      })

      $("#add-todo-form").on("submit", function(event){
        event.preventDefault()
        let arr = $("#add-todo-form").serializeArray()
        let title = arr[0].value
        let description = arr[1].value
        let status = arr[2].value
        let due_date = arr[3].value
        console.log({
          title,
          description,
          due_date,
          status
        })
        addTodos(title, description, due_date, status)
        $("#add-todo-form").hide()
      })

      $("#edit-todo-form").on("submit", function(event){
        event.preventDefault()
        let arr = $("#edit-todo-form").serializeArray()
        let title = arr[0].value
        let description = arr[1].value
        let status = arr[2].value
        let due_date = arr[3].value
        console.log({
          title,
          description,
          due_date,
          status
        })
        editTodo(title, description, due_date, status, id)
        $("#edit-todo-form").hide()
      })
  </script>
</body>
</html>