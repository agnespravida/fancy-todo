<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <title>Document</title>
</head>
<body>

  <div id="homepage" class="container">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#login-page">Login</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#register-page">Register</a>
      </li>
    </ul>
  
    <!-- Tab panes -->
    <div class="tab-content">
      <div id="login-page" class="container tab-pane active"><br>
        <div class="row">
          <div class="col-sm-8">

          </div>
          <div class="col-sm-4">
            <div id="invalidlogin">
  
            </div>
            <h3>Login</h3>
            <form id="submit-login-form">
              <div class="form-group">
                Email:<br>
                <input type="text" name="email" id="email-login" required><br>
              </div>
              <div class="form-group">
                Password:<br>
                <input type="password" name="password" id="password-login" required><br>
              </div>
            
              <button type="submit" class="btn btn-primary">Login</button>
             
            </form>
          </div>
        </div>
      </div>
      <div id="register-page" class="container tab-pane fade"><br>
        <div class="row">
          <div class="col-sm-8">

          </div>
          <div class="col-sm-4">
            <div id="register">
  
            </div>
            <h3>Register</h3>
            <form id="submit-register-form">
              <div class="form-group">
                First Name:<br>
                <input type="text" name="first_name" id="first_name-register" required><br>
              </div>
              <div class="form-group">
                Last Name: <br>
                <input type="text" name="last_name" id="last_name-register"><br>
              </div>
              <div class="form-group">
                Username: <br>
                <input type="text" name="last_name" id="username-register" required><br>
              </div>
              <div class="form-group">
                Email:<br>
                <input type="text" name="email" id="email-register" required><br>
              </div>
              <div class="form-group">
                Password:<br>
                <input type="password" name="password" id="password-register" required><br>
              </div>
              <button type="submit" class="btn btn-primary">Register</button>
            </form>
        </div>
        </div>
      </div>
    </div>
  </div>

  <div id ="main-page">
    <button id="btn-logout">logout</button>
      <button id="btn-add-todo" class="btn btn-success" data-toggle="modal" data-target="#add-form">Add Todo</button>
      <div id="todos-list">
      
      </div>
    </div>
  </div>

  <div class="container edit-modal">
    <!-- The Modal -->
    <div class="modal" id="edit-form">
      <div class="modal-dialog">
        <div class="modal-content">
          
          <!-- Modal body -->
          <div class="modal-body">
            <form id="edit-todo-form">
              <h1>Edit Form</h1>
              Title:<br>
              <input type="text" id="title-edit" name="title"><br>
              Description:<br>
              <input type="text" id="description-edit" name="description"><br>
              Status:<br>
              <input type="text" id="status-edit" name="status"><br>
              Due Date:<br>
              <input type="date" id="due_date-edit" name="due_date"><br>
              <button type="submit">Submit</button> <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    
  </div>
  

  <div class="container add-modal">
    <!-- The Modal -->
    <div class="modal" id="add-form">
      <div class="modal-dialog">
        <div class="modal-content">
        
          <!-- Modal body -->
          <div class="modal-body">
            <div id="add-form-notif">

            </div>
            <h2>Add Form</h2>
            <form id="add-todo-form">
              <div class="form-group">
                Title:<br>
                <input type="text" id="title-add" name="title"><br>
              </div>
              <div class="form-group">
                Description:<br>
                <input type="text" id="description-add" name="description"><br>
              </div>
              <div class="form-group">
                Status:<br>
                <input type="text" id="status-add" name="status"><br>
              </div>
              <div class="form-group">
                Due Date:<br>
                <input type="date" id="due_date-add" name="due_date"><br>
              </div>
              <button type="submit" class="btn btn-primary">Submit</button> <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    


  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script>
    let TodoId = null
    function showHomePage(){
      $("#homepage").show()
      $("#main-page").hide()
      $("#add-todo-form").hide()
      $("#edit-todo-form").hide()
    }
    function showMainPage(){
      $("#homepage").hide()
      $("#main-page").show()
      $("#add-todo-form").hide()
      $("#edit-todo-form").hide()
      showTodos()
    }
    function loginUser(email, password){
      $.ajax({
        method: "POST",
        url: "http://localhost:3000/login",
        data: {
          email,
          password
        }
      })
      .done(function(response) {
        localStorage.setItem("access_token", response.access_token)
        console.log("Berhasil login")
        showMainPage()
      })
      .fail(xhr => {
        $("#invalidlogin").prepend(`
        <div class="alert alert-danger alert-dismisible">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        ${xhr.responseJSON.message}
        </div>
        `)
        console.log(xhr)
      })
      .always(() => {
        $("#email-login").val("")
        $("#password-login").val("")
      });

    }

    function registerUser(first_name, last_name, username, email,password){
      $.ajax({
        url: "http://localhost:3000/register",
        method: "POST",
        data: {
          first_name,
          last_name,
          username,
          email,
          password
        }
      })
      .done(response => {
        $("#register").prepend(`
          <div class="alert alert-success alert-dismisible">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          Successfully register, please log in to get access the app!
          </div>
        `)
        showHomePage()
        console.log(response)
      })
      .fail(xhr => {
        for(let i = 0; i < xhr.responseJSON.message.length; i++){
          $("#register").prepend(`
          <div class="alert alert-danger alert-dismisible">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          ${xhr.responseJSON.message[i]}
          </div>
        `)
        }
        console.log(xhr)
      })
      .always(() => {
        $("#first_name-register").val("")
        $("#last_name-register").val("")
        $("#username-register").val("")
        $("#email-register").val("")
        $("#password-register").val("")
      });
    }
    function showTodos(){
      $.ajax({
        method: "GET",
        url: "http://localhost:3000/todos/",
        headers: {
          access_token: localStorage.getItem("access_token")
        }
        
      })
      .done(function( response ) {
        //console.log(response)
        $("#todos-list").empty()
        for (let i = 0; i < response.length; i++){
          $("#todos-list").prepend(`
          <div style="background-color: aqua;">
            <p><strong>${response[i].title}<strong></p>
            <p>${response[i].description}</p>
            <p>${response[i].due_date}</p><br>
            <button id="btn-delete-todo" onclick="deleteTodo(${response[i].id})">Delete</button> <button id="btn-edit-todo" class="btn btn-success" data-toggle="modal" data-target="#edit-form" onclick="toggleEditForm(${response[i].id})">Edit</button>
          </div>
          `)
        }
      })
      .fail(xhr => {
        console.log(xhr)
      })

    }
    function addTodos(title, description, due_date, status){
      $.ajax({
        method: "POST",
        url: "http://localhost:3000/todos",
        headers: {
          access_token: localStorage.getItem("access_token")
        },
        data: {
          title,
          description,
          due_date,
          status
        }
      })
      .done(response => {
        $("#add-form-notif").empty()
        $("#add-form-notif").prepend(`
        <div class="alert alert-success alert-dismisible">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          Successfully add todo list!
          </div>
        `)
        showMainPage()
        console.log(response)
      })
      .fail(xhr => {
        for(let i = 0; i < xhr.responseJSON.message.length; i++){
          $("#add-form-notif").prepend(`
          <div class="alert alert-danger alert-dismisible">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          ${xhr.responseJSON.message[i]}
          </div>
        `)
        }
        console.log(xhr)
      })
      .always(() => {
        $("#title-add").val("")
        $("#description-add").val("")
        $("#status-add").val("")
        $("#due_date-add").val("")
      })
    }
    function toggleEditForm(id){
      $.ajax({
        method: "GET",
        url: "http://localhost:3000/todos/" + id,
        headers: {
          access_token: localStorage.getItem("access_token")
        }
        
      })
      .done(function(response) {
        $("#title-edit").val(response.title)
        $("#description-edit").val(response.description)
        $("#status-edit").val(response.status)
        $("#due_date-edit").val(response.due_date)
        TodoId = response.id

        $("#edit-todo-form").toggle()
        console.log(response)
      })
      .fail(function(xhr) {
        console.log(xhr)
      })
    }
    function editTodo(title, description, due_date, status, TodoId){
      $.ajax({
        method: "PUT",
        url: "http://localhost:3000/todos/" + TodoId,
        headers: {
          access_token: localStorage.getItem("access_token")
        },
        data: {
          title,
          description,
          due_date,
          status
        }
      })
      .done(function( response ) {
        //localStorage.setItem("access_token", response.access_token)
        console.log("Berhasil edit data")
        showMainPage()
      })
      .fail(xhr => {
        console.log(xhr)
      })
      .always(() => {
        $("#title-edit").val("")
        $("#description-edit").val("")
        $("due_date-edit").val("")
        $("#status-edit").val("")
      });
    }
    function deleteTodo(id){
      $.ajax({
        method: "DELETE",
        url: "http://localhost:3000/todos/" + id,
        headers: {
          access_token: localStorage.getItem("access_token")
        }
      })
      .done(response => {
        showMainPage()
      })
      .fail(err => {
        console.log(err)
      })
    }
    function logoutUser(){
      localStorage.clear()
      showHomePage()
    }


    $(document).ready(function(){
      if(localStorage.getItem("access_token")){
        showMainPage()
      }
      else {
        showHomePage()
      }

      $("#submit-login-form").on("submit", function(event){
        event.preventDefault()
        let email = $("#email-login").val()
        let password = $("#password-login").val()
        loginUser(email,password)
        console.log({
          email,
          password
        })
      })
      })

      $("#submit-register-form").on("submit", function(event){
        event.preventDefault()
        let first_name = $("#first_name-register").val()
        let last_name = $("#last_name-register").val()
        let username = $("#username-register").val()
        let email = $("#email-register").val()
        let password = $("#password-register").val()
        registerUser(first_name, last_name, username, email,password)
        console.log({
          email,
          password
        })
      })

      

      $("#btn-add-todo").on("click", function(){
        $("#add-form-notif").empty()
        $("#add-todo-form").toggle()
      })

      $("#add-todo-form").on("submit", function(event){
        event.preventDefault()
        let title = $("#title-add").val()
        let description = $("#description-add").val()
        let status = $("#status-add").val()
        let due_date = $("#due_date-add").val()
        console.log({
          title,
          description,
          due_date,
          status
        })
        addTodos(title, description, due_date, status)
      })

      $("#edit-todo-form").on("submit", function(event){
        event.preventDefault()
        let title = $("#title-edit").val()
        let description = $("#description-edit").val()
        let status = $("#status-edit").val()
        let due_date = $("#due_date-edit").val()
        console.log({
          title,
          description,
          due_date,
          status
        })
        editTodo(title, description, due_date, status, TodoId)
      })

      $("#btn-logout").on("click", () => {
        logoutUser()
      })
  </script>
</body>
</html>